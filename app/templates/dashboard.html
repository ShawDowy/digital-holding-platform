{% extends "base.html" %}

{% block content %}
<style>
    /* Custom Dashboard Styles */
    .stat-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    /* Gradients */
    .gradient-blue { background: linear-gradient(135deg, #3b82f6, #0ea5e9); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .gradient-green { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
    .gradient-orange { background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
    .gradient-purple { background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
    
    /* Text Glows */
    .text-glow-success { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    .text-glow-danger { text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
    .text-glow-primary { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

    /* Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .badge-success-glow { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .badge-warning-glow { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
    .badge-danger-glow { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge-neutral-glow { background: rgba(148, 163, 184, 0.15); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.3); }
</style>

<!-- Row 1: Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 text-uppercase small fw-bold mb-2">Капитализация</h6>
                        <h2 class="fw-bold mb-0 text-white">${{ "{:,.0f}".format(stats.estimated_value) }}</h2>
                        <small class="text-success small"><i class="fas fa-arrow-up me-1"></i>+2.4%</small>
                    </div>
                    <div class="icon-box gradient-blue text-white">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 text-uppercase small fw-bold mb-2">Оборудование</h6>
                        <h2 class="display-6 fw-bold mb-0 text-white">{{ stats.equipment }}</h2>
                        <small class="text-white-50 small">Единиц техники</small>
                    </div>
                    <div class="icon-box gradient-green text-white">
                        <i class="fas fa-cogs"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 text-uppercase small fw-bold mb-2">В работе</h6>
                        <h2 class="display-6 fw-bold mb-0 text-white">{{ stats.orders_active }}</h2>
                        <small class="text-white-50 small">Активных заказов</small>
                    </div>
                    <div class="icon-box gradient-orange text-white">
                        <i class="fas fa-hammer"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50 text-uppercase small fw-bold mb-2">Склад</h6>
                        <h2 class="display-6 fw-bold mb-0 text-white">{{ "%.0f"|format(stats.warehouse_total) }}т</h2>
                        {% if kpi.low_stock > 0 %}
                        <small class="text-danger small fw-bold"><i class="fas fa-exclamation-circle me-1"></i>Дефицит!</small>
                        {% else %}
                        <small class="text-success small">Норма</small>
                        {% endif %}
                    </div>
                    <div class="icon-box gradient-purple text-white">
                        <i class="fas fa-cubes"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Row 2: KPIs & Charts -->
<div class="row mb-4">
    <div class="col-md-8">
        <!-- KPI Grid -->
        <div class="row g-4 mb-4">
            <!-- Quality KPI -->
            <div class="col-md-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6 class="text-white-50 text-uppercase small fw-bold">Качество исполнения</h6>
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div class="d-flex align-items-end justify-content-between mb-2">
                            <h2 class="mb-0 fw-bold {% if kpi.quality >= 90 %}text-success text-glow-success{% else %}text-danger text-glow-danger{% endif %}">
                                {{ kpi.quality }}%
                            </h2>
                            <small class="text-white-50">Цель: 95%</small>
                        </div>
                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar {% if kpi.quality >= 90 %}bg-success{% else %}bg-danger{% endif %}" style="width: {{ kpi.quality }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Efficiency KPI -->
            <div class="col-md-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6 class="text-white-50 text-uppercase small fw-bold">Эффективность</h6>
                            <i class="fas fa-bolt text-primary"></i>
                        </div>
                        <div class="d-flex align-items-end justify-content-between mb-2">
                            <h2 class="mb-0 fw-bold text-primary text-glow-primary">
                                {{ kpi.completion }}%
                            </h2>
                            <small class="text-white-50">План выполнен</small>
                        </div>
                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar bg-primary" style="width: {{ kpi.completion }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OTD KPI -->
            <div class="col-md-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6 class="text-white-50 text-uppercase small fw-bold">Сроки (OTD)</h6>
                            <i class="fas fa-clock text-warning"></i>
                        </div>
                        <div class="d-flex align-items-end justify-content-between mb-2">
                            {% if kpi.overdue > 0 %}
                            <h2 class="mb-0 fw-bold text-danger text-glow-danger">{{ kpi.overdue }}</h2>
                            {% else %}
                            <h2 class="mb-0 fw-bold text-success text-glow-success">OK</h2>
                            {% endif %}
                            <small class="text-white-50">Просрочено</small>
                        </div>
                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar {% if kpi.overdue > 0 %}bg-danger{% else %}bg-success{% endif %}" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Availability -->
            <div class="col-md-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h6 class="text-white-50 text-uppercase small fw-bold">Доступность оборудования</h6>
                            <i class="fas fa-tools text-white-50"></i>
                        </div>
                        <div class="d-flex align-items-end justify-content-between mb-2">
                            <h2 class="mb-0 fw-bold {% if kpi.availability >= 85 %}text-success text-glow-success{% else %}text-warning{% endif %}">
                                {{ kpi.availability }}%
                            </h2>
                            <small class="text-white-50">В строю</small>
                        </div>
                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar {% if kpi.availability >= 85 %}bg-success{% else %}bg-warning{% endif %}" style="width: {{ kpi.availability }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="card stat-card mb-4">
            <div class="card-header border-0 pb-0 pt-3">
                <h6 class="text-white text-uppercase small fw-bold mb-0">Динамика производства (7 дней)</h6>
            </div>
            <div class="card-body" style="height: 250px; position: relative;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Column -->
    <div class="col-md-4">
        <!-- Live IoT Telemetry -->
        <div class="card stat-card mb-4" style="background: rgba(15, 23, 42, 0.95);">
            <div class="card-header border-0 pb-0 pt-3 d-flex justify-content-between align-items-center">
                <h6 class="text-white text-uppercase small fw-bold mb-0">IoT Телеметрия (Live)</h6>
                <div class="spinner-grow text-success spinner-grow-sm" role="status"></div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0" style="--bs-table-bg: transparent; color: #f1f5f9;">
                        <thead>
                            <tr style="border-color: rgba(255,255,255,0.1);">
                                <th class="ps-3 text-white-50 small font-weight-normal">Устройство</th>
                                <th class="text-white-50 small font-weight-normal">T°C</th>
                                <th class="text-white-50 small font-weight-normal">Вибр.</th>
                                <th style="width: 30px;"></th>
                            </tr>
                        </thead>
                        <tbody style="border-top: none;">
                            {% for eq in live_equipment %}
                            <tr style="border-color: rgba(255,255,255,0.05);">
                                <td class="ps-3 small">
                                    <div class="fw-bold text-white">{{ eq.tag }}</div>
                                    <div class="text-white-50" style="font-size: 0.7rem;">{{ eq.name|truncate(15) }}</div>
                                </td>
                                <td>
                                    <span id="table-temp-{{ eq.id }}" class="badge {% if eq.status == 'maintenance' %}bg-secondary text-white-50{% elif eq.temperature > 80 %}bg-danger{% elif eq.temperature > 60 %}bg-warning text-dark{% else %}bg-success bg-opacity-25 text-success{% endif %}">
                                        {% if eq.status == 'maintenance' %}
                                        <i class="fas fa-tools"></i>
                                        {% else %}
                                        {{ eq.temperature }}°
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span id="table-vib-{{ eq.id }}" class="badge {% if eq.status == 'maintenance' %}bg-secondary text-white-50{% elif eq.vibration > 5 %}bg-danger{% elif eq.vibration > 2 %}bg-warning text-dark{% else %}bg-info bg-opacity-25 text-info{% endif %}">
                                        {% if eq.status == 'maintenance' %}
                                        —
                                        {% else %}
                                        {{ eq.vibration }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="text-end pe-3">
                                    <button class="btn btn-sm btn-link text-white-50 p-0" data-bs-toggle="modal" data-bs-target="#telemetryModal{{ eq.id }}">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Equipment Status -->
        <div class="card stat-card mb-4">
            <div class="card-header border-0 pb-0 pt-3">
                <h6 class="text-white text-uppercase small fw-bold mb-0">Состояние парка</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center" style="height: 250px; position: relative;">
                <canvas id="equipmentPolarChart"></canvas>
            </div>
        </div>

        <!-- Defects Analysis -->
        <div class="card stat-card mb-4">
            <div class="card-header border-0 pb-0 pt-3">
                <h6 class="text-white text-uppercase small fw-bold mb-0">Анализ брака</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center" style="height: 250px; position: relative;">
                {% if defect_values|sum > 0 %}
                <canvas id="defectsDoughnutChart"></canvas>
                {% else %}
                <div class="text-center text-white-50">Нет данных о браке</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Row 3: Top Products & Recent Orders -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-header border-0 pb-0 pt-3">
                <h6 class="text-white text-uppercase small fw-bold mb-0">Топ продуктов (Тоннаж)</h6>
            </div>
            <div class="card-body" style="height: 300px; position: relative;">
                <canvas id="productionBarChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-header border-0 pb-0 pt-3 d-flex justify-content-between align-items-center">
                <h6 class="text-white text-uppercase small fw-bold mb-0">Лента заказов</h6>
                <span class="badge bg-dark border border-secondary text-white-50">Live</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="--bs-table-bg: transparent; --bs-table-hover-bg: rgba(255,255,255,0.05); color: #f1f5f9;">
                        <thead>
                            <tr style="border-color: rgba(255,255,255,0.1);">
                                <th class="ps-4" style="background: transparent; color: #94a3b8;">ID</th>
                                <th style="background: transparent; color: #94a3b8;">Продукт</th>
                                <th class="text-end pe-4" style="background: transparent; color: #94a3b8;">Статус</th>
                            </tr>
                        </thead>
                        <tbody style="border-top: none;">
                            {% for order in recent_orders %}
                            <tr style="border-color: rgba(255,255,255,0.05);">
                                <td class="ps-4 font-monospace text-primary small">#{{ order.order_number.split('-')|last }}</td>
                                <td class="text-white small">{{ order.product_name }}</td>
                                <td class="text-end pe-4">
                                    {% if order.status == 'problem' %}
                                    <span class="status-badge badge-danger-glow">Проблема</span>
                                    {% elif order.status == 'completed' %}
                                    <span class="status-badge badge-success-glow">Готово</span>
                                    {% elif order.status == 'in_progress' %}
                                    <span class="status-badge badge-warning-glow">В работе</span>
                                    {% else %}
                                    <span class="status-badge badge-neutral-glow">Новый</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals Container -->
{% for eq in live_equipment %}
<!-- Telemetry Modal -->
<div class="modal fade" id="telemetryModal{{ eq.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #0f172a; color: #f1f5f9; border: 1px solid #334155;">
            <div class="modal-header" style="border-bottom: 1px solid #334155;">
                <h5 class="modal-title">
                    <i class="fas fa-microchip me-2 text-primary"></i>Телеметрия: {{ eq.tag }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h6 class="text-white mb-1">{{ eq.name }}</h6>
                        <div class="small text-white-50">{{ eq.type }}</div>
                    </div>
                    <div id="modal-status-{{ eq.id }}">
                        {% if eq.status == 'operational' %}
                        <span class="badge bg-success">В РАБОТЕ</span>
                        {% elif eq.status == 'broken' %}
                        <span class="badge bg-danger">СЛОМАНО</span>
                        {% elif eq.status == 'maintenance' %}
                        <span class="badge bg-warning text-dark">НА РЕМОНТЕ</span>
                        {% endif %}
                    </div>
                </div>
                
                <div id="modal-telemetry-content-{{ eq.id }}">
                    {% if eq.status == 'maintenance' %}
                    <div class="p-4 rounded border border-warning border-opacity-25 bg-warning bg-opacity-10 text-center mb-4">
                        <i class="fas fa-tools fa-2x text-warning mb-3"></i>
                        <h6 class="text-warning mb-1">Техническое обслуживание</h6>
                        <small class="text-white-50">Сбор телеметрии приостановлен на время ремонтных работ</small>
                    </div>
                    {% else %}
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="p-3 rounded border border-secondary text-center" style="background-color: #020617; border-color: #334155 !important;">
                                <small class="text-white-50 d-block mb-1">Температура</small>
                                <h2 class="mb-0 {% if eq.temperature > 80 %}text-danger{% elif eq.temperature > 60 %}text-warning{% else %}text-success{% endif %}">
                                    {{ eq.temperature }}°C
                                </h2>
                                <small class="text-muted" style="font-size: 0.7rem;">Норма: < 60°C</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded border border-secondary text-center" style="background-color: #020617; border-color: #334155 !important;">
                                <small class="text-white-50 d-block mb-1">Вибрация</small>
                                <h2 class="mb-0 {% if eq.vibration > 5 %}text-danger{% elif eq.vibration > 2 %}text-warning{% else %}text-info{% endif %}">
                                    {{ eq.vibration }}
                                </h2>
                                <small class="text-muted" style="font-size: 0.7rem;">mm/s</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="small text-white-50 mb-1">Статус подключения</label>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">ONLINE</span>
                        <small id="modal-last-update-{{ eq.id }}" class="text-muted">Последнее обновление: {{ eq.last_telemetry_update.strftime('%H:%M:%S') if eq.last_telemetry_update else 'N/A' }}</small>
                    </div>
                </div>

                <div class="alert alert-secondary d-flex align-items-center mb-0 border-0 bg-opacity-10" style="background-color: rgba(255,255,255,0.05); color: #94a3b8;">
                    <i class="fas fa-info-circle me-2 text-info"></i>
                    <small>Данные обновляются в реальном времени с IoT шлюза.</small>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #334155;">
                <a href="/equipment/{{ eq.id }}" class="btn btn-outline-primary w-100">Перейти к оборудованию</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    // 1. Polar Area Chart (Equipment)
    const ctxPolar = document.getElementById('equipmentPolarChart').getContext('2d');
    new Chart(ctxPolar, {
        type: 'polarArea',
        data: {
            labels: ['Работает', 'Сломано', 'На ремонте'],
            datasets: [{
                data: [{{ status_data.operational }}, {{ status_data.broken }}, {{ status_data.maintenance }}],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.6)', // Green
                    'rgba(239, 68, 68, 0.6)',  // Red
                    'rgba(245, 158, 11, 0.6)'  // Orange
                ],
                borderColor: '#1e293b',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { display: false, backdropColor: 'transparent' }
                }
            },
            plugins: {
                legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: 'Inter', size: 11 }, boxWidth: 10 } }
            }
        }
    });

    // 2. Bar Chart (Top Products)
    const ctxBar = document.getElementById('productionBarChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: [{% for l in prod_labels %}"{{l}}",{% endfor %}],
            datasets: [{
                label: 'Произведено (тонн)',
                data: [{{ prod_values|join(',') }}],
                backgroundColor: '#3b82f6',
                borderRadius: 4,
                barThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // 3. Line Chart (Trend)
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: [{% for l in trend_labels %}"{{l}}",{% endfor %}],
            datasets: [{
                label: 'Объем заказов (т)',
                data: [{{ trend_values|join(',') }}],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#8b5cf6',
                pointBorderColor: '#fff',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#94a3b8' },
                    beginAtZero: true
                },
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#94a3b8' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // 4. Doughnut Chart (Defects)
    {% if defect_values|sum > 0 %}
    const ctxDefect = document.getElementById('defectsDoughnutChart').getContext('2d');
    new Chart(ctxDefect, {
        type: 'doughnut',
        data: {
            labels: [{% for l in defect_labels %}"{{l}}",{% endfor %}],
            datasets: [{
                data: [{{ defect_values|join(',') }}],
                backgroundColor: [
                    '#f87171', '#fbbf24', '#60a5fa', '#a78bfa', '#34d399'
                ],
                borderColor: '#1e293b',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { 
                    position: 'right', 
                    labels: { color: '#94a3b8', font: { family: 'Inter', size: 10 }, boxWidth: 10 } 
                }
            }
        }
    });
    {% endif %}

    // Telemetry Polling
    function updateTelemetry() {
        fetch('/api/telemetry')
            .then(response => response.json())
            .then(data => {
                data.forEach(eq => {
                    // 1. Update Table Badges
                    const tempBadge = document.getElementById(`table-temp-${eq.id}`);
                    const vibBadge = document.getElementById(`table-vib-${eq.id}`);
                    
                    if (eq.status === 'maintenance') {
                        if (tempBadge) {
                            tempBadge.innerHTML = '<i class="fas fa-tools"></i>';
                            tempBadge.className = 'badge bg-secondary text-white-50';
                        }
                        if (vibBadge) {
                            vibBadge.innerHTML = '—';
                            vibBadge.className = 'badge bg-secondary text-white-50';
                        }
                    } else {
                        if (tempBadge) {
                            tempBadge.innerText = `${eq.temperature}°`;
                            tempBadge.className = `badge ${eq.temperature > 80 ? 'bg-danger' : (eq.temperature > 60 ? 'bg-warning text-dark' : 'bg-success bg-opacity-25 text-success')}`;
                        }
                        
                        if (vibBadge) {
                            vibBadge.innerText = `${eq.vibration}`;
                            vibBadge.className = `badge ${eq.vibration > 5 ? 'bg-danger' : (eq.vibration > 2 ? 'bg-warning text-dark' : 'bg-info bg-opacity-25 text-info')}`;
                        }
                    }

                    // 2. Update Modal Status
                    const modalStatus = document.getElementById(`modal-status-${eq.id}`);
                    if (modalStatus) {
                        let statusHtml = '';
                        if (eq.status === 'operational') {
                            statusHtml = '<span class="badge bg-success">В РАБОТЕ</span>';
                        } else if (eq.status === 'broken') {
                            statusHtml = '<span class="badge bg-danger">СЛОМАНО</span>';
                        } else if (eq.status === 'maintenance') {
                            statusHtml = '<span class="badge bg-warning text-dark">НА РЕМОНТЕ</span>';
                        }
                        // Only update if changed to avoid flicker
                        if (modalStatus.innerHTML.trim() !== statusHtml) {
                            modalStatus.innerHTML = statusHtml;
                        }
                    }

                    // 3. Update Modal Content (Telemetry vs Maintenance)
                    const modalContent = document.getElementById(`modal-telemetry-content-${eq.id}`);
                    if (modalContent) {
                        if (eq.status === 'maintenance') {
                            // Only update if not already showing maintenance
                            if (!modalContent.querySelector('.border-warning')) {
                                modalContent.innerHTML = `
                                <div class="p-4 rounded border border-warning border-opacity-25 bg-warning bg-opacity-10 text-center mb-4">
                                    <i class="fas fa-tools fa-2x text-warning mb-3"></i>
                                    <h6 class="text-warning mb-1">Техническое обслуживание</h6>
                                    <small class="text-white-50">Сбор телеметрии приостановлен на время ремонтных работ</small>
                                </div>`;
                            }
                        } else {
                            // Update values if operational/broken
                            const tempClass = eq.temperature > 80 ? 'text-danger' : (eq.temperature > 60 ? 'text-warning' : 'text-success');
                            const vibClass = eq.vibration > 5 ? 'text-danger' : (eq.vibration > 2 ? 'text-warning' : 'text-info');
                            
                            modalContent.innerHTML = `
                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <div class="p-3 rounded border border-secondary text-center" style="background-color: #020617; border-color: #334155 !important;">
                                        <small class="text-white-50 d-block mb-1">Температура</small>
                                        <h2 class="mb-0 ${tempClass}">${eq.temperature}°C</h2>
                                        <small class="text-muted" style="font-size: 0.7rem;">Норма: < 60°C</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded border border-secondary text-center" style="background-color: #020617; border-color: #334155 !important;">
                                        <small class="text-white-50 d-block mb-1">Вибрация</small>
                                        <h2 class="mb-0 ${vibClass}">${eq.vibration}</h2>
                                        <small class="text-muted" style="font-size: 0.7rem;">mm/s</small>
                                    </div>
                                </div>
                            </div>`;
                        }
                    }

                    // 4. Update Last Update Time
                    const lastUpdate = document.getElementById(`modal-last-update-${eq.id}`);
                    if (lastUpdate) {
                        lastUpdate.innerText = `Последнее обновление: ${eq.last_update}`;
                    }
                });
            })
            .catch(err => console.error('Telemetry fetch error:', err));
    }

    // Start polling every 3 seconds
    setInterval(updateTelemetry, 3000);
</script>
{% endblock %}
